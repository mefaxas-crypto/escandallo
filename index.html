<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Costos de Recetas</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #D7A27A; /* Primary Tan/Beige Background */
        }
        .table-cell {
            padding: 8px 12px;
            border-bottom: 1px solid #e5e7eb;
        }
        .header-cell {
            padding: 10px 12px;
            border-bottom: 2px solid #604029; /* Dark Brown */
            background-color: rgba(255, 255, 255, 0.5);
            font-weight: 600;
            color: #604029; /* Dark Brown */
        }
        .summary-label {
            font-weight: 500;
            color: #604029; /* Dark Brown */
        }
        .summary-value {
            font-weight: 600;
            color: #374151; /* Dark Gray */
        }
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
        .modal-overlay {
            transition: opacity 0.3s ease;
        }
        /* Toggle Switch Styles */
        .toggle-bg:after {
            content: '';
            position: absolute;
            top: 0.125rem;
            left: 0.125rem;
            background-color: white;
            border: 1px solid #d1d5db;
            border-radius: 9999px;
            height: 1.25rem;
            width: 1.25rem;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }
        input:checked + .toggle-bg:after {
            transform: translateX(100%);
            border-color: white;
        }
        input:checked + .toggle-bg {
            background-color: #604029; /* Dark Brown */
        }
        #notification-popup {
            transition: opacity 0.5s, transform 0.5s;
        }
        .loader {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #604029; /* Dark Brown */
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-7xl">
        <header class="text-center mb-8">
             <img src="https://i.imgur.com/bX34R22.png" alt="Hotel Logo" class="h-24 mx-auto">
        </header>

        <nav class="mb-8 bg-white/60 p-3 rounded-xl shadow-sm border border-white/30 flex justify-center space-x-2 md:space-x-4 backdrop-blur-sm overflow-x-auto">
            <button id="nav-calculator" class="px-4 py-2 rounded-md text-sm font-medium transition-colors bg-[#604029] text-white shadow-sm flex-shrink-0">Plantilla de Receta</button>
            <button id="nav-ingredients" class="px-4 py-2 rounded-md text-sm font-medium transition-colors text-[#604029] hover:bg-white/80 border border-transparent hover:border-white flex-shrink-0">Ingredientes</button>
            <button id="nav-recipes" class="px-4 py-2 rounded-md text-sm font-medium transition-colors text-[#604029] hover:bg-white/80 border border-transparent hover:border-white flex-shrink-0">Recetas</button>
            <button id="nav-dishes" class="px-4 py-2 rounded-md text-sm font-medium transition-colors text-[#604029] hover:bg-white/80 border border-transparent hover:border-white flex-shrink-0">Platos</button>
            <button id="nav-inventory" class="px-4 py-2 rounded-md text-sm font-medium transition-colors text-[#604029] hover:bg-white/80 border border-transparent hover:border-white flex-shrink-0">Inventario</button>
            <button id="nav-inventory-history" class="px-4 py-2 rounded-md text-sm font-medium transition-colors text-[#604029] hover:bg-white/80 border border-transparent hover:border-white flex-shrink-0">Historial de Cortes</button>
            <button id="nav-variance-analysis" class="px-4 py-2 rounded-md text-sm font-medium transition-colors text-[#604029] hover:bg-white/80 border border-transparent hover:border-white flex-shrink-0">Análisis de Varianza</button>
            <button id="nav-reports" class="px-4 py-2 rounded-md text-sm font-medium transition-colors text-[#604029] hover:bg-white/80 border border-transparent hover:border-white flex-shrink-0">Reporte Semanal</button>
            <button id="nav-report-history" class="px-4 py-2 rounded-md text-sm font-medium transition-colors text-[#604029] hover:bg-white/80 border border-transparent hover:border-white flex-shrink-0">Historial de Reportes</button>
        </nav>

        <main id="app-content">
            <div id="view-calculator">
                <div class="bg-white/80 p-6 rounded-2xl shadow-lg border border-white/40 backdrop-blur-md">
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6 pb-4 border-b border-[#604029]/20">
                        <div class="md:col-span-2">
                            <label for="recipe-name" class="block text-sm font-medium text-[#604029]">Nombre de la Receta</label>
                            <input type="text" id="recipe-name" placeholder="Ej: Caldo de Pollo" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:ring-[#604029] focus:border-[#604029]">
                        </div>
                        <div class="flex items-end space-x-2">
                            <div>
                                <label for="recipe-yield" class="block text-sm font-medium text-[#604029]">Rendimiento</label>
                                <input type="number" id="recipe-yield" value="1" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:ring-[#604029] focus:border-[#604029]">
                            </div>
                            <div>
                                 <label for="recipe-yield-unit" class="block text-sm font-medium text-[#604029]">Unidad</label>
                                <select id="recipe-yield-unit" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:ring-[#604029] focus:border-[#604029]">
                                    <option value="">Seleccione</option>
                                    <option value="un.">un.</option>
                                    <option value="g">g</option>
                                    <option value="kg">kg</option>
                                    <option value="oz">oz</option>
                                    <option value="lb">lb</option>
                                    <option value="ml">ml</option>
                                    <option value="l">l</option>
                                </select>
                            </div>
                        </div>
                         <div>
                            <label for="recipe-type" class="block text-sm font-medium text-[#604029]">Tipo de Receta</label>
                            <div class="mt-2 flex items-center space-x-3">
                                <span id="recipe-type-label-internal" class="text-gray-500">Producto Interno</span>
                                <label for="recipe-type-toggle" class="flex items-center cursor-pointer">
                                    <div class="relative">
                                        <input type="checkbox" id="recipe-type-toggle" class="sr-only" checked>
                                        <div class="block bg-gray-200 w-10 h-6 rounded-full toggle-bg"></div>
                                    </div>
                                </label>
                                <span id="recipe-type-label-final" class="font-semibold text-[#604029]">Plato Final</span>
                            </div>
                        </div>
                        <div class="flex items-end justify-end">
                             <button id="clear-recipe" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-red-700 w-full md:w-auto">Limpiar Receta</button>
                        </div>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-transparent">
                            <thead class="bg-transparent">
                                <tr>
                                    <th class="header-cell text-left text-sm uppercase tracking-wider">Código</th>
                                    <th class="header-cell text-left text-sm uppercase tracking-wider w-2/5">Ingredientes</th>
                                    <th class="header-cell text-left text-sm uppercase tracking-wider">Cantidad</th>
                                    <th class="header-cell text-left text-sm uppercase tracking-wider">Un.</th>
                                    <th class="header-cell text-left text-sm uppercase tracking-wider">Precio Unitario</th>
                                    <th class="header-cell text-left text-sm uppercase tracking-wider">Importe</th>
                                    <th class="header-cell text-right text-sm uppercase tracking-wider"></th>
                                </tr>
                            </thead>
                            <tbody id="recipe-table-body" class="divide-y divide-gray-200">
                                <tr id="no-ingredients-row">
                                    <td colspan="7" class="text-center py-10 text-gray-500">
                                        La receta está vacía. Añada un ingrediente abajo.
                                    </td>
                                </tr>
                            </tbody>
                            <tfoot class="bg-transparent">
                                <tr class="border-t-2 border-[#604029]/20">
                                    <td class="table-cell"></td>
                                    <td class="table-cell relative">
                                        <input type="text" id="ingredient-search-input" placeholder="Buscar por código o nombre..." class="w-full p-2 border border-gray-300 rounded-md focus:ring-[#604029] focus:border-[#604029]">
                                        <div id="ingredient-search-results" class="absolute z-10 w-full bg-white border rounded-md mt-1 shadow-lg hidden max-h-60 overflow-y-auto"></div>
                                    </td>
                                    <td class="table-cell flex items-center space-x-1">
                                        <input type="number" id="recipe-quantity-input" placeholder="Cantidad" class="w-24 px-2 py-1 border border-gray-300 rounded-md focus:ring-[#604029] focus:border-[#604029]">
                                        <select id="recipe-unit-input" class="p-2 border border-gray-300 rounded-md focus:ring-[#604029] focus:border-[#604029]">
                                            <option value="g">g</option>
                                            <option value="kg">kg</option>
                                            <option value="oz">oz</option>
                                            <option value="lb">lb</option>
                                        </select>
                                    </td>
                                    <td id="cost-per-gram-preview" class="table-cell text-gray-600"></td>
                                    <td class="table-cell"></td>
                                    <td class="table-cell"></td>
                                    <td class="table-cell text-right">
                                        <button id="add-to-recipe-btn" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-green-700">Añadir</button>
                                    </td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    <div class="mt-8 pt-6 border-t-2 border-[#604029]/20">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-x-8 gap-y-4">
                            
                            <div class="space-y-3">
                                <div class="flex justify-between items-center">
                                    <span class="summary-label">Costo M.P.</span>
                                    <span id="summary-costo-mp" class="summary-value">$0.00</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="summary-label">Costo P/P</span>
                                    <span id="summary-costo-pp" class="summary-value">$0.00</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <label for="summary-imprevistos-percent" class="summary-label">Imprevistos</label>
                                    <div class="flex items-center space-x-2">
                                        <input type="number" id="summary-imprevistos-percent" value="5" class="w-16 p-1 border rounded-md text-right focus:ring-[#604029] focus:border-[#604029]">
                                        <span>%</span>
                                        <span id="summary-imprevistos-value" class="summary-value w-20 text-right">$0.00</span>
                                    </div>
                                </div>
                                <hr>
                                <div class="flex justify-between items-center text-lg">
                                    <span class="summary-label">Costo Total</span>
                                    <span id="summary-total-costo" class="summary-value">$0.00</span>
                                </div>
                            </div>

                            <div id="pricing-column" class="space-y-3">
                                <div class="flex justify-between items-center">
                                    <label for="summary-cost-percent" class="summary-label">% de Costo</label>
                                    <div class="flex items-center space-x-2">
                                        <input type="number" id="summary-cost-percent" value="30" class="w-16 p-1 border rounded-md text-right focus:ring-[#604029] focus:border-[#604029]">
                                        <span>%</span>
                                    </div>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="summary-label">Precio Sugerido</span>
                                    <span id="summary-precio-sugerido" class="summary-value">$0.00</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <label for="summary-tax-percent" class="summary-label">ITBIS</label>
                                    <div class="flex items-center space-x-2">
                                        <input type="number" id="summary-tax-percent" value="18" class="w-16 p-1 border rounded-md text-right focus:ring-[#604029] focus:border-[#604029]">
                                        <span>%</span>
                                        <span id="summary-tax-value" class="summary-value w-20 text-right">$0.00</span>
                                    </div>
                                </div>
                                <hr>
                                <div class="flex justify-between items-center text-lg">
                                    <span class="summary-label">Precio Factura</span>
                                    <span id="summary-precio-factura" class="summary-value">$0.00</span>
                                </div>
                            </div>

                            <div class="space-y-3 pt-6">
                                <div id="menu-assignment-section">
                                    <label for="menu-select" class="block text-sm font-medium text-[#604029]">Asignar a Menú</label>
                                    <select id="menu-select" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:ring-[#604029] focus:border-[#604029]"></select>
                                </div>
                                <button id="save-recipe-btn" class="w-full bg-[#604029] text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:opacity-90 transition-opacity">
                                    Guardar Receta
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-ingredients" class="hidden">
                 <div class="bg-white/80 p-6 rounded-2xl shadow-lg border border-white/40 backdrop-blur-md">
                    <h2 class="text-2xl font-semibold mb-4 border-b pb-3 text-[#604029] border-[#604029]/20">Gestión de Ingredientes</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-1 space-y-8">
                            <div>
                                <h3 class="font-semibold text-lg mb-2 text-[#604029]">Añadir Nuevo Ingrediente</h3>
                                <form id="ingredient-form" class="space-y-4">
                                    <input type="number" id="ingredient-code" placeholder="Código de Material (SAP)" required class="block w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-[#604029] focus:border-[#604029]">
                                    <input type="text" id="ingredient-name" placeholder="Nombre del Ingrediente" required class="block w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-[#604029] focus:border-[#604029]">
                                    <div class="flex items-center space-x-2">
                                        <input type="number" id="purchase-quantity" placeholder="Cantidad" required class="block w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-[#604029] focus:border-[#604029]">
                                        <select id="purchase-unit" required class="block w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-[#604029] focus:border-[#604029]">
                                             <option value="">Unidad</option>
                                             <option value="g">g</option>
                                             <option value="kg">kg</option>
                                             <option value="lb">lb</option>
                                             <option value="oz">oz</option>
                                             <option value="l">l</option>
                                             <option value="ml">ml</option>
                                             <option value="un.">un.</option>
                                        </select>
                                    </div>
                                    <input type="number" id="purchase-cost" step="0.01" placeholder="Costo del Paquete ($)" required class="block w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-[#604029] focus:border-[#604029]">
                                    <button type="submit" class="w-full bg-[#604029] text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:opacity-90 transition-opacity">
                                        Añadir a la Lista
                                    </button>
                                </form>
                            </div>
                            <div>
                                <h3 class="font-semibold text-lg mb-2 text-[#604029]">Importar / Exportar</h3>
                                <p class="text-sm text-gray-600 mb-2">Importe su archivo de SAP. El sistema detectará las columnas automáticamente.</p>
                                <input type="file" id="csv-file-input" accept=".csv,.xlsx" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-white/80 file:text-[#604029] hover:file:bg-white"/>
                                <div id="csv-status" class="text-sm mt-2 h-5"></div>
                                <button id="import-csv-btn" class="mt-2 w-full bg-[#604029] text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:opacity-90 transition-opacity disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center" disabled>
                                    Importar
                                </button>
                                <button id="export-csv-btn" class="mt-2 w-full bg-white text-[#604029] font-semibold py-2 px-4 rounded-lg border border-[#604029]/30 hover:bg-[#604029] hover:text-white transition-colors">
                                    Exportar a CSV
                                </button>
                            </div>
                        </div>
                        <div class="lg:col-span-2">
                            <h3 class="font-semibold text-lg mb-2 text-[#604029]">Lista Actual</h3>
                            <div class="overflow-x-auto">
                                <table class="min-w-full bg-transparent">
                                    <thead class="bg-transparent">
                                        <tr>
                                            <th class="header-cell text-left">Código</th>
                                            <th class="header-cell text-left">Nombre</th>
                                            <th class="header-cell text-left">Costo de Compra</th>
                                            <th class="header-cell text-left">Costo/g</th>
                                            <th class="header-cell text-right">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="ingredient-library-table" class="divide-y divide-gray-200">
                                        </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-recipes" class="hidden">
                <div class="bg-white/80 p-6 rounded-2xl shadow-lg border border-white/40 backdrop-blur-md">
                    <h2 class="text-2xl font-semibold mb-4 border-b pb-3 text-[#604029] border-[#604029]/20">Todas las Recetas</h2>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-transparent">
                            <thead class="bg-transparent">
                                <tr>
                                    <th class="header-cell text-left">Nombre de la Receta</th>
                                    <th class="header-cell text-left">Tipo</th>
                                    <th class="header-cell text-left">Costo Total</th>
                                    <th class="header-cell text-left">Rendimiento</th>
                                    <th class="header-cell text-right">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="all-recipes-table" class="divide-y divide-gray-200">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="view-dishes" class="hidden">
                <div class="bg-white/80 p-6 rounded-2xl shadow-lg border border-white/40 backdrop-blur-md">
                    <div class="flex justify-between items-center mb-4 border-b pb-3 border-[#604029]/20">
                        <h2 class="text-2xl font-semibold text-[#604029]">Dashboard de Menús</h2>
                        <button id="manage-menus-btn" class="bg-white text-[#604029] font-semibold py-2 px-4 rounded-lg border border-[#604029]/30 hover:bg-[#604029] hover:text-white transition-colors">Gestionar Menús</button>
                    </div>
                    <div id="menus-dashboard" class="space-y-8">
                        </div>
                </div>
            </div>
             
            <div id="view-inventory" class="hidden">
                <div class="bg-white/80 p-6 rounded-2xl shadow-lg border border-white/40 backdrop-blur-md">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-semibold text-[#604029]">Inventario Actual</h2>
                        <button id="inventory-snapshot-btn" class="bg-white text-[#604029] font-semibold py-2 px-4 rounded-lg border border-[#604029]/30 hover:bg-[#604029] hover:text-white transition-colors">Hacer Corte de Inventario</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-transparent">
                            <thead class="bg-transparent">
                                <tr>
                                    <th class="header-cell text-left">Código</th>
                                    <th class="header-cell text-left">Nombre</th>
                                    <th class="header-cell text-left">Stock Actual</th>
                                    <th class="header-cell text-left">Unidad</th>
                                    <th class="header-cell text-left">Par Stock</th>
                                    <th class="header-cell text-left">Costo Unitario</th>
                                    <th class="header-cell text-left">Valor de Stock</th>
                                </tr>
                            </thead>
                            <tbody id="inventory-table-body" class="divide-y divide-gray-200">
                            </tbody>
                             <tfoot class="bg-transparent">
                                <tr class="border-t-4 border-[#604029]">
                                    <td colspan="6" class="table-cell text-right font-bold text-lg text-[#604029]">Valor Total del Inventario</td>
                                    <td id="total-inventory-value" class="table-cell font-bold text-lg text-[#374151]">$0.00</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>

            <div id="view-inventory-history" class="hidden">
                <div class="bg-white/80 p-6 rounded-2xl shadow-lg border border-white/40 backdrop-blur-md">
                    <h2 class="text-2xl font-semibold text-[#604029] mb-4">Historial de Cortes de Inventario</h2>
                    <div id="inventory-snapshot-list" class="space-y-4">
                        <p class="text-center text-gray-500">No hay cortes guardados.</p>
                    </div>
                </div>
            </div>

            <div id="view-variance-analysis" class="hidden">
                 <div class="bg-white/80 p-6 rounded-2xl shadow-lg border border-white/40 backdrop-blur-md">
                     <h2 class="text-2xl font-semibold text-[#604029] mb-4">Análisis de Varianza</h2>
                     <div class="flex items-center space-x-4 mb-6">
                        <label for="variance-period-select" class="summary-label">Seleccionar Semana del Reporte:</label>
                        <select id="variance-period-select" class="p-2 border border-gray-300 rounded-md focus:ring-[#604029] focus:border-[#604029]"></select>
                         <button id="calculate-variance-btn" class="bg-[#604029] text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:opacity-90">Analizar Varianza</button>
                     </div>
                      <div id="variance-results-container" class="hidden">
                         <h3 class="text-xl font-semibold text-[#604029] mb-2">Resultados del Análisis</h3>
                         <div class="overflow-x-auto">
                            <table class="min-w-full bg-transparent">
                                <thead class="bg-transparent">
                                    <tr>
                                        <th class="header-cell text-left">Ingrediente</th>
                                        <th class="header-cell text-right">Consumo Teórico (g)</th>
                                        <th class="header-cell text-right">Consumo Real (g)</th>
                                        <th class="header-cell text-right">Varianza (g)</th>
                                        <th class="header-cell text-right">Varianza ($)</th>
                                    </tr>
                                </thead>
                                <tbody id="variance-results-table" class="divide-y divide-gray-200"></tbody>
                                 <tfoot class="bg-transparent">
                                    <tr class="border-t-4 border-[#604029]">
                                        <td colspan="4" class="table-cell text-right font-bold text-lg text-[#604029]">Varianza Total</td>
                                        <td id="total-variance-value" class="table-cell font-bold text-lg text-red-600 text-right">$0.00</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                     </div>
                 </div>
            </div>

            <div id="view-reports" class="hidden">
                 <div class="bg-white/80 p-6 rounded-2xl shadow-lg border border-white/40 backdrop-blur-md">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-semibold text-[#604029]">Bitácora Diaria y Reporte Semanal</h2>
                         <div class="flex items-center space-x-2">
                             <button id="prev-day-btn" class="p-2 rounded-md hover:bg-white/80">◀</button>
                             <input type="date" id="report-date-picker" class="p-2 border rounded-md">
                             <button id="next-day-btn" class="p-2 rounded-md hover:bg-white/80">▶</button>
                         </div>
                        <button id="lock-week-btn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700">Cerrar y Guardar Semana</button>
                    </div>

                     <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-2">
                            <h3 class="text-lg font-semibold text-[#604029] mb-3">Ventas del Día por Plato</h3>
                            <div id="sales-by-dish-container" class="space-y-2 max-h-96 overflow-y-auto pr-2"></div>
                             <h3 class="text-lg font-semibold text-[#604029] mt-6 mb-3">Compras del Día</h3>
                             <div class="flex items-center space-x-2">
                                <label for="daily-purchase-input" class="summary-label">Total Compras ($):</label>
                                <input type="number" id="daily-purchase-input" class="p-2 border rounded-md text-right">
                             </div>
                        </div>

                        <div class="lg:col-span-1 bg-white/50 p-6 rounded-xl border">
                             <h3 class="text-xl font-semibold text-[#604029] mb-4 text-center">Resumen de la Semana Actual</h3>
                             <div class="space-y-4">
                                <div class="flex justify-between items-center">
                                    <span class="summary-label text-lg">Ventas de la Semana</span>
                                     <span id="report-total-sales" class="summary-value text-lg w-40 text-right pr-2">$0.00</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <label for="report-inv-initial" class="summary-label text-lg">Inventario Inicial</label>
                                    <div class="flex items-center space-x-2">
                                        <input type="number" id="report-inv-initial" class="report-input w-40 p-2 border rounded-md text-right text-lg font-semibold" readonly>
                                    </div>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="summary-label text-lg">Compras</span>
                                    <span id="report-purchases" class="summary-value text-lg w-40 text-right pr-2">$0.00</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <label for="report-inv-final" class="summary-label text-lg">Inventario Final</label>
                                     <div class="flex items-center space-x-2">
                                        <input type="number" id="report-inv-final" class="report-input w-40 p-2 border rounded-md text-right text-lg font-semibold" readonly>
                                    </div>
                                </div>
                                <hr class="border-t-2 border-[#604029]/30 my-4">
                                <div class="flex justify-between items-center bg-[#604029] text-white p-3 rounded-lg">
                                    <span class="font-bold text-xl">COSTO DE PARTES</span>
                                    <span id="report-cogs" class="font-bold text-xl">$0.00</span>
                                </div>
                                <div class="flex justify-between items-center bg-[#604029] text-white p-3 rounded-lg">
                                    <span class="font-bold text-xl">% COSTO</span>
                                    <span id="report-cost-percent" class="font-bold text-xl">0.00%</span>
                                </div>
                            </div>
                        </div>
                     </div>
                 </div>
            </div>

            <div id="view-report-history" class="hidden">
                 <div class="bg-white/80 p-6 rounded-2xl shadow-lg border border-white/40 backdrop-blur-md">
                    <h2 class="text-2xl font-semibold text-[#604029] mb-4">Historial de Reportes Semanales</h2>
                    <div id="weekly-reports-list" class="space-y-4">
                        <p class="text-center text-gray-500">No hay reportes guardados.</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="edit-ingredient-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden modal-overlay">
        <div class="bg-[#D7A27A] rounded-lg shadow-xl p-6 w-full max-w-md transform transition-all border border-white/30">
            <h3 class="text-xl font-semibold mb-4 text-[#604029]">Editar Ingrediente</h3>
            <form id="edit-ingredient-form" class="space-y-4">
                <input type="hidden" id="edit-ingredient-id">
                <div>
                    <label class="block text-sm font-medium text-[#604029]">Código de Material</label>
                    <input type="number" id="edit-ingredient-code" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-[#604029] focus:border-[#604029]">
                </div>
                <div>
                    <label class="block text-sm font-medium text-[#604029]">Nombre</label>
                    <input type="text" id="edit-ingredient-name" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-[#604029] focus:border-[#604029]">
                </div>
                <div class="flex items-center space-x-2">
                    <div class="flex-1">
                        <label class="block text-sm font-medium text-[#604029]">Cantidad de Compra</label>
                        <input type="number" id="edit-purchase-quantity" class="mt-1 block w-full px-3 py-2 border rounded-md focus:ring-[#604029] focus:border-[#604029]">
                    </div>
                    <div class="flex-1">
                        <label class="block text-sm font-medium text-[#604029]">Unidad de Compra</label>
                         <select id="edit-purchase-unit" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-[#604029] focus:border-[#604029]">
                             <option value="">Unidad</option>
                             <option value="g">g</option>
                             <option value="kg">kg</option>
                             <option value="lb">lb</option>
                             <option value="oz">oz</option>
                             <option value="l">l</option>
                             <option value="ml">ml</option>
                             <option value="un.">un.</option>
                         </select>
                    </div>
                </div>
                 <div>
                    <label class="block text-sm font-medium text-[#604029]">Costo del Paquete</label>
                    <input type="number" step="0.01" id="edit-purchase-cost" class="mt-1 block w-full px-3 py-2 border rounded-md focus:ring-[#604029] focus:border-[#604029]">
                </div>
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" id="cancel-edit-btn" class="bg-white/80 text-[#604029] font-semibold py-2 px-4 rounded-lg border border-[#604029]/30 hover:bg-[#604029] hover:text-white transition-colors">Cancelar</button>
                    <button type="submit" class="bg-[#604029] text-white font-semibold py-2 px-4 rounded-lg">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>

    <div id="confirm-delete-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden modal-overlay">
        <div class="bg-[#D7A27A] rounded-lg shadow-xl p-6 w-full max-w-sm transform transition-all border border-white/30">
            <h3 id="confirm-title" class="text-xl font-semibold mb-4 text-[#604029]">Confirmar Eliminación</h3>
            <p id="confirm-message" class="text-gray-800 mb-6">¿Está seguro de que desea eliminar este item? Esta acción no se puede deshacer.</p>
            <div class="flex justify-end space-x-3">
                <button id="cancel-delete-btn" class="bg-white/80 text-[#604029] font-semibold py-2 px-4 rounded-lg border border-[#604029]/30 hover:bg-[#604029] hover:text-white transition-colors">Cancelar</button>
                <button id="confirm-delete-btn" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-lg">Eliminar</button>
            </div>
        </div>
    </div>
    
    <div id="manage-menus-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden modal-overlay">
        <div class="bg-[#D7A27A] rounded-lg shadow-xl p-6 w-full max-w-md transform transition-all border border-white/30">
            <h3 class="text-xl font-semibold mb-4 text-[#604029]">Gestionar Menús</h3>
            <form id="add-menu-form" class="flex items-center space-x-2 mb-4">
                <input type="text" id="new-menu-name" placeholder="Nombre del nuevo menú" class="block w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-[#604029] focus:border-[#604029]" required>
                <button type="submit" class="bg-[#604029] text-white font-semibold py-2 px-4 rounded-lg">Añadir</button>
            </form>
            <div id="menu-list" class="space-y-2">
                </div>
             <div class="flex justify-end mt-6">
                <button type="button" id="close-menus-modal-btn" class="bg-white/80 text-[#604029] font-semibold py-2 px-4 rounded-lg border border-[#604029]/30 hover:bg-[#604029] hover:text-white transition-colors">Cerrar</button>
            </div>
        </div>
    </div>

    <div id="notification-popup" class="fixed top-5 right-5 bg-green-500 text-white py-3 px-5 rounded-lg shadow-xl opacity-0 -translate-y-20 transform">
    </div>


    <script type="module">
        // --- FIREBASE SDK IMPORTS ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, getDocs, setDoc, deleteDoc, addDoc, writeBatch, updateDoc, serverTimestamp, query, orderBy, limit, getDoc, collectionGroup, where } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyCIQhs9rOwGUGNKXZfCkU0tUmsH7nw3c5g",
            authDomain: "recetario-bamboo-mf.firebaseapp.com",
            projectId: "recetario-bamboo-mf",
            storageBucket: "recetario-bamboo-mf.appspot.com",
            messagingSenderId: "1002163997524",
            appId: "1:1002163997524:web:bae3be323df5f45eb356c1",
            measurementId: "G-X5NQSEVP2V"
        };
        
        // --- FIREBASE INITIALIZATION ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // --- DATA STORE ---
        const ingredientsCol = collection(db, 'ingredients');
        const recipesCol = collection(db, 'recipes');
        const menusCol = collection(db, 'menus');
        const snapshotsCol = collection(db, 'inventorySnapshots');
        const weeklyReportsCol = collection(db, 'weeklyReports');
        const dailySalesCol = collection(db, 'dailySales');

        let ingredients = []; 
        let savedRecipes = []; 
        let menus = [];
        let inventorySnapshots = [];
        let weeklyReports = [];
        let combinedIngredients = [];
        let currentRecipe = {}; 
        let selectedIngredientId = null;
        let validatedCsvContent = null;
        let totalInventoryValue = 0;
        let currentReportDate = new Date();
        let weeklyDataCache = {};

        // --- DOM ELEMENT SELECTORS ---
        const selectors = {
            nav: {
                calculator: document.getElementById('nav-calculator'),
                ingredients: document.getElementById('nav-ingredients'),
                recipes: document.getElementById('nav-recipes'),
                dishes: document.getElementById('nav-dishes'),
                inventory: document.getElementById('nav-inventory'),
                inventoryHistory: document.getElementById('nav-inventory-history'),
                varianceAnalysis: document.getElementById('nav-variance-analysis'),
                reports: document.getElementById('nav-reports'),
                reportHistory: document.getElementById('nav-report-history'),
            },
            views: {
                calculator: document.getElementById('view-calculator'),
                ingredients: document.getElementById('view-ingredients'),
                recipes: document.getElementById('view-recipes'),
                dishes: document.getElementById('view-dishes'),
                inventory: document.getElementById('view-inventory'),
                inventoryHistory: document.getElementById('view-inventory-history'),
                varianceAnalysis: document.getElementById('view-variance-analysis'),
                reports: document.getElementById('view-reports'),
                reportHistory: document.getElementById('view-report-history'),
            },
            calculator: {
                recipeTableBody: document.getElementById('recipe-table-body'),
                clearRecipeBtn: document.getElementById('clear-recipe'),
                noIngredientsRow: document.getElementById('no-ingredients-row'),
                ingredientSearchInput: document.getElementById('ingredient-search-input'),
                ingredientSearchResults: document.getElementById('ingredient-search-results'),
                recipeQuantityInput: document.getElementById('recipe-quantity-input'),
                recipeUnitInput: document.getElementById('recipe-unit-input'),
                addToRecipeBtn: document.getElementById('add-to-recipe-btn'),
                costPerGramPreview: document.getElementById('cost-per-gram-preview'),
                recipeYield: document.getElementById('recipe-yield'),
                recipeYieldUnit: document.getElementById('recipe-yield-unit'),
                recipeName: document.getElementById('recipe-name'),
                recipeTypeToggle: document.getElementById('recipe-type-toggle'),
                recipeTypeLabelFinal: document.getElementById('recipe-type-label-final'),
                recipeTypeLabelInternal: document.getElementById('recipe-type-label-internal'),
                pricingColumn: document.getElementById('pricing-column'),
                saveRecipeBtn: document.getElementById('save-recipe-btn'),
                menuAssignmentSection: document.getElementById('menu-assignment-section'),
                menuSelect: document.getElementById('menu-select'),
                summaryInputs: {
                    imprevistosPercent: document.getElementById('summary-imprevistos-percent'),
                    costPercent: document.getElementById('summary-cost-percent'),
                    taxPercent: document.getElementById('summary-tax-percent'),
                },
                summaryValues: {
                    costoMp: document.getElementById('summary-costo-mp'),
                    costoPp: document.getElementById('summary-costo-pp'),
                    imprevistosValue: document.getElementById('summary-imprevistos-value'),
                    totalCosto: document.getElementById('summary-total-costo'),
                    precioSugerido: document.getElementById('summary-precio-sugerido'),
                    taxValue: document.getElementById('summary-tax-value'),
                    precioFactura: document.getElementById('summary-precio-factura'),
                },
            },
            library: {
                form: document.getElementById('ingredient-form'),
                table: document.getElementById('ingredient-library-table'),
                csvInput: document.getElementById('csv-file-input'),
                csvStatus: document.getElementById('csv-status'),
                importCsvBtn: document.getElementById('import-csv-btn'),
                exportCsvBtn: document.getElementById('export-csv-btn'),
            },
            recipes: {
                table: document.getElementById('all-recipes-table'),
            },
            dishes: {
                dashboard: document.getElementById('menus-dashboard'),
                manageMenusBtn: document.getElementById('manage-menus-btn'),
            },
            inventory: {
                 tableBody: document.getElementById('inventory-table-body'),
                 totalValue: document.getElementById('total-inventory-value'),
                 snapshotBtn: document.getElementById('inventory-snapshot-btn'),
            },
            inventoryHistory: {
                list: document.getElementById('inventory-snapshot-list'),
            },
            varianceAnalysis: {
                periodSelect: document.getElementById('variance-period-select'),
                calculateBtn: document.getElementById('calculate-variance-btn'),
                resultsContainer: document.getElementById('variance-results-container'),
                resultsTable: document.getElementById('variance-results-table'),
                totalVariance: document.getElementById('total-variance-value'),
            },
            reports: {
                datePicker: document.getElementById('report-date-picker'),
                prevDayBtn: document.getElementById('prev-day-btn'),
                nextDayBtn: document.getElementById('next-day-btn'),
                salesByDishContainer: document.getElementById('sales-by-dish-container'),
                dailyPurchaseInput: document.getElementById('daily-purchase-input'),
                lockWeekBtn: document.getElementById('lock-week-btn'),
                summary: {
                    totalSales: document.getElementById('report-total-sales'),
                    purchases: document.getElementById('report-purchases'),
                    cogs: document.getElementById('report-cogs'),
                    costPercent: document.getElementById('report-cost-percent'),
                    initialInvInput: document.getElementById('report-inv-initial'),
                    finalInvInput: document.getElementById('report-inv-final'),
                }
            },
            reportHistory: {
                list: document.getElementById('weekly-reports-list'),
            },
            modals: {
                editIngredient: {
                    overlay: document.getElementById('edit-ingredient-modal'),
                    form: document.getElementById('edit-ingredient-form'),
                    id: document.getElementById('edit-ingredient-id'),
                    code: document.getElementById('edit-ingredient-code'),
                    name: document.getElementById('edit-ingredient-name'),
                    quantity: document.getElementById('edit-purchase-quantity'),
                    unit: document.getElementById('edit-purchase-unit'),
                    cost: document.getElementById('edit-purchase-cost'),
                    cancelBtn: document.getElementById('cancel-edit-btn'),
                },
                confirmDelete: {
                    overlay: document.getElementById('confirm-delete-modal'),
                    title: document.getElementById('confirm-title'),
                    message: document.getElementById('confirm-message'),
                    cancelBtn: document.getElementById('cancel-delete-btn'),
                    confirmBtn: document.getElementById('confirm-delete-btn'),
                },
                manageMenus: {
                    overlay: document.getElementById('manage-menus-modal'),
                    form: document.getElementById('add-menu-form'),
                    input: document.getElementById('new-menu-name'),
                    list: document.getElementById('menu-list'),
                    closeBtn: document.getElementById('close-menus-modal-btn'),
                }
            },
            notification: document.getElementById('notification-popup'),
        };

        // --- EVENT LISTENERS ---
        function setupEventListeners() {
            Object.values(selectors.nav).forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const viewNameKebab = e.currentTarget.id.replace('nav-', '');
                    const viewName = viewNameKebab.replace(/-./g, x => x[1].toUpperCase());
                    switchView(viewName);
                });
            });

            const calc = selectors.calculator;
            calc.clearRecipeBtn.addEventListener('click', handleClearRecipe);
            calc.addToRecipeBtn.addEventListener('click', handleAddToRecipe);
            calc.ingredientSearchInput.addEventListener('input', handleIngredientSearch);
            calc.recipeQuantityInput.addEventListener('keydown', handleEnterKeyAdd);
            calc.recipeUnitInput.addEventListener('keydown', handleEnterKeyAdd);
            calc.recipeYield.addEventListener('input', calculateSummary);
            calc.recipeTypeToggle.addEventListener('change', handleRecipeTypeChange);
            calc.saveRecipeBtn.addEventListener('click', handleSaveRecipe);
            Object.values(calc.summaryInputs).forEach(input => input.addEventListener('input', calculateSummary));

            selectors.library.form.addEventListener('submit', handleAddIngredient);
            selectors.library.csvInput.addEventListener('change', handleFileValidation);
            selectors.library.importCsvBtn.addEventListener('click', handleCsvImport);
            selectors.library.exportCsvBtn.addEventListener('click', handleCsvExport);
            selectors.modals.editIngredient.form.addEventListener('submit', handleUpdateIngredient);
            selectors.modals.editIngredient.cancelBtn.addEventListener('click', closeEditModal);
            
            selectors.dishes.manageMenusBtn.addEventListener('click', () => selectors.modals.manageMenus.overlay.classList.remove('hidden'));
            selectors.modals.manageMenus.closeBtn.addEventListener('click', () => selectors.modals.manageMenus.overlay.classList.add('hidden'));
            selectors.modals.manageMenus.form.addEventListener('submit', handleAddMenu);

            selectors.inventory.snapshotBtn.addEventListener('click', handleInventorySnapshot);
            
            selectors.varianceAnalysis.calculateBtn.addEventListener('click', calculateVariance);

            selectors.reports.datePicker.addEventListener('input', handleDateChange);
            selectors.reports.prevDayBtn.addEventListener('click', () => changeReportDay(-1));
            selectors.reports.nextDayBtn.addEventListener('click', () => changeReportDay(1));
            selectors.reports.dailyPurchaseInput.addEventListener('change', handleDailyDataUpdate);
            selectors.reports.lockWeekBtn.addEventListener('click', handleLockWeek);

            document.addEventListener('click', (e) => {
                if (selectors.calculator.ingredientSearchInput && !selectors.calculator.ingredientSearchInput.contains(e.target)) {
                    selectors.calculator.ingredientSearchResults.classList.add('hidden');
                }
            });
        }
        
        // --- AUTHENTICATION & DATA LOADING ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                onSnapshot(ingredientsCol, snapshot => {
                    ingredients = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data(), isRecipe: false }));
                    updateCombinedIngredientsAndRender();
                });
                onSnapshot(recipesCol, snapshot => {
                    savedRecipes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    updateCombinedIngredientsAndRender();
                });
                onSnapshot(menusCol, snapshot => {
                    menus = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderAllDynamicViews();
                });
                onSnapshot(query(snapshotsCol, orderBy("createdAt", "desc")), snapshot => {
                    inventorySnapshots = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderInventoryHistoryView();
                    fetchWeeklyData(currentReportDate);
                });
                onSnapshot(query(weeklyReportsCol, orderBy("id", "desc")), snapshot => {
                    weeklyReports = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    populateVariancePeriodSelect();
                    renderReportHistoryView();
                });
            } else {
                signInAnonymously(auth).catch(error => console.error("Anonymous sign-in failed:", error));
            }
        });

        function updateCombinedIngredientsAndRender() {
            updateCombinedIngredients();
            renderAllDynamicViews();
        }

        function updateCombinedIngredients() {
            const internalProductsAsIngredients = savedRecipes
                .filter(r => !r.isFinalDish)
                .map(r => {
                    const recipeIngredients = r.ingredients || [];
                    const totalCost = recipeIngredients.reduce((acc, item) => acc + (item.grams * item.costPerGram), 0);
                    let totalGrams = 0;
                    if (['l', 'ml', 'kg', 'lb', 'oz', 'g'].includes(r.yieldUnit)) {
                        totalGrams = r.yield * (CONVERSIONS[r.yieldUnit] || 0);
                    } else if (r.yieldUnit === 'un.') {
                        totalGrams = recipeIngredients.reduce((acc, item) => acc + item.grams, 0);
                    }
                    const costPerGram = totalGrams > 0 ? totalCost / totalGrams : 0;
                    return {
                        id: r.id, name: r.name, materialCode: 'N/A', costPerGram, isRecipe: true,
                        stockUnit: r.yieldUnit, currentStock: r.currentStock || 0, parStock: r.parStock || 0,
                        ingredients: recipeIngredients, yield: r.yield, yieldUnit: r.yieldUnit
                    };
                });
            
             const rawIngredients = ingredients.map(ing => ({
                ...ing, stockUnit: ing.purchaseUnit, currentStock: ing.currentStock || 0, parStock: ing.parStock || 0
            }));

            combinedIngredients = [...rawIngredients, ...internalProductsAsIngredients];
        }

        // --- NAVIGATION & VIEW MANAGEMENT ---
        function switchView(viewName) {
            const formattedViewName = viewName.replace(/([a-z0-9]|(?=[A-Z]))([A-Z])/g, '$1-$2').toLowerCase();
            Object.values(selectors.views).forEach(view => view.classList.add('hidden'));
            if(selectors.views[viewName]) selectors.views[viewName].classList.remove('hidden');

            const navButtons = document.querySelectorAll('nav button');
            navButtons.forEach(btn => {
                btn.classList.remove('bg-[#604029]', 'text-white', 'shadow-sm');
                btn.classList.add('text-[#604029]', 'hover:bg-white/80', 'border', 'border-transparent', 'hover:border-white');
            });

            const activeBtn = document.getElementById(`nav-${formattedViewName}`);
            if(activeBtn) {
                activeBtn.classList.add('bg-[#604029]', 'text-white', 'shadow-sm');
                activeBtn.classList.remove('text-[#604029]', 'hover:bg-white/80', 'border', 'border-transparent', 'hover:border-white');
            }
        }

        // --- UI LOGIC ---
        function handleRecipeTypeChange() {
            currentRecipe.isFinalDish = selectors.calculator.recipeTypeToggle.checked;
            updateUIVisibility();
        }

        function updateUIVisibility() {
            const isFinal = selectors.calculator.recipeTypeToggle.checked;
            selectors.calculator.pricingColumn.style.display = isFinal ? 'block' : 'none';
            selectors.calculator.menuAssignmentSection.style.display = isFinal ? 'block' : 'none';
            
            const btn = selectors.calculator.saveRecipeBtn;
            if (isFinal) {
                btn.textContent = 'Guardar Plato Final';
            } else {
                btn.textContent = 'Guardar como Producto Interno';
            }

            const finalLabel = selectors.calculator.recipeTypeLabelFinal;
            const internalLabel = selectors.calculator.recipeTypeLabelInternal;
            finalLabel.classList.toggle('font-semibold', isFinal);
            finalLabel.classList.toggle('text-[#604029]', isFinal);
            finalLabel.classList.toggle('text-gray-500', !isFinal);
            internalLabel.classList.toggle('font-semibold', !isFinal);
            internalLabel.classList.toggle('text-[#604029]', !isFinal);
            internalLabel.classList.toggle('text-gray-500', isFinal);
        }

        function showNotification(message, isError = false) {
            const popup = selectors.notification;
            popup.textContent = message;

            popup.classList.remove('bg-green-500', 'bg-red-500');
            popup.classList.add(isError ? 'bg-red-500' : 'bg-green-500');

            popup.classList.remove('opacity-0', '-translate-y-20');
            popup.classList.add('opacity-100', 'translate-y-0');

            setTimeout(() => {
                popup.classList.remove('opacity-100', 'translate-y-0');
                popup.classList.add('opacity-0', '-translate-y-20');
            }, 3000);
        }

        // --- INGREDIENT LIBRARY LOGIC ---
        const CONVERSIONS = { g: 1, kg: 1000, lb: 453.592, oz: 28.3495, l: 1000, ml: 1, 'un.': 1 };
        
        function calculateCostPerGram(quantity, unit, cost) {
            if (unit === 'un.') {
                 const totalUnits = quantity || 1;
                 return cost / totalUnits;
            }
            const totalGrams = quantity * (CONVERSIONS[unit] || 0);
            return totalGrams > 0 ? cost / totalGrams : 0;
        }

        async function handleAddIngredient(e) {
            e.preventDefault();
            const form = e.target;
            const code = parseInt(form.querySelector('[id$="-code"]').value);
            const name = form.querySelector('[id$="-name"]').value.trim();
            const purchaseQuantity = parseFloat(form.querySelector('#purchase-quantity, #edit-purchase-quantity').value);
            const purchaseUnit = form.querySelector('#purchase-unit, #edit-purchase-unit').value;
            const purchaseCost = parseFloat(form.querySelector('[id$="-cost"]').value);

            if (name && code && purchaseQuantity > 0 && purchaseUnit && !isNaN(purchaseCost)) {
                const newIngredient = { 
                    materialCode: code, 
                    name, 
                    purchaseQuantity,
                    purchaseUnit,
                    purchaseCost, 
                    costPerGram: calculateCostPerGram(purchaseQuantity, purchaseUnit, purchaseCost),
                    currentStock: 0,
                    parStock: 0
                };
                try {
                    await setDoc(doc(db, 'ingredients', String(code)), newIngredient);
                    form.reset();
                    showNotification("Ingrediente añadido exitosamente.");
                    if(form.id.includes('edit')) closeEditModal();
                } catch (error) {
                    console.error("Error al añadir ingrediente:", error);
                    showNotification("No se pudo añadir el ingrediente.", true);
                }
            }
        }

        function handleFileValidation(event) {
            const file = event.target.files[0];
            const statusEl = selectors.library.csvStatus;
            const importBtn = selectors.library.importCsvBtn;

            if (!file) {
                statusEl.textContent = '';
                importBtn.disabled = true;
                validatedCsvContent = null;
                return;
            }

            const reader = new FileReader();
            const fileExtension = file.name.split('.').pop().toLowerCase();

            reader.onload = (e) => {
                let text;
                if (fileExtension === 'xlsx') {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    text = XLSX.utils.sheet_to_csv(worksheet, { FS: ';' });
                } else {
                    text = e.target.result;
                }

                const header = text.split('\n')[0].toLowerCase();
                
                const requiredHeaders = ['material', 'texto breve', 'unidad medida pedido', 'precio neto'];
                const hasAllHeaders = requiredHeaders.every(h => header.includes(h));

                if (hasAllHeaders) {
                    statusEl.textContent = "Archivo validado. Listo para importar.";
                    statusEl.className = "text-sm mt-2 h-5 text-green-600";
                    importBtn.disabled = false;
                    validatedCsvContent = text;
                } else {
                    statusEl.textContent = "El archivo no tiene el formato correcto.";
                    statusEl.className = "text-sm mt-2 h-5 text-red-600";
                    importBtn.disabled = true;
                    validatedCsvContent = null;
                }
            };

            if (fileExtension === 'xlsx') {
                reader.readAsArrayBuffer(file);
            } else {
                reader.readAsText(file);
            }
        }

        async function handleCsvImport() {
            if (!validatedCsvContent) return;

            const importBtn = selectors.library.importCsvBtn;
            const originalBtnText = importBtn.textContent;
            importBtn.innerHTML = `<div class="loader"></div>`;
            importBtn.disabled = true;

            const lines = validatedCsvContent.split('\n');
            const header = lines[0].toLowerCase().split(';').map(h => h.trim().replace(/"/g, ''));
            
            const codeIndex = header.findIndex(h => h.includes('material'));
            const nameIndex = header.findIndex(h => h.includes('texto breve'));
            const unitIndex = header.findIndex(h => h.includes('unidad medida pedido'));
            const costIndex = header.findIndex(h => h.includes('precio neto'));
            const quantityIndex = header.findIndex(h => h.includes('cantidad de pedido'));
            
            const latestEntries = new Map();

            for (let i = 1; i < lines.length; i++) {
                const data = lines[i].split(';');
                if (data.length < header.length) continue;
                const materialCode = parseInt(data[codeIndex]?.trim());
                if (isNaN(materialCode)) continue;
                latestEntries.set(materialCode, data);
            }

            const batch = writeBatch(db);
            let importCount = 0;

            for (const [materialCode, data] of latestEntries.entries()) {
                let name = data[nameIndex]?.trim();
                let purchaseUnit = data[unitIndex]?.trim().toLowerCase();
                const purchaseCost = parseFloat(data[costIndex]?.trim());
                let purchaseQuantity = parseFloat(data[quantityIndex]?.trim());

                if (!isNaN(purchaseQuantity) && purchaseUnit && !isNaN(purchaseCost)) {
                    const ingredientRef = doc(db, 'ingredients', String(materialCode));
                     const existingIngredient = ingredients.find(ing => ing.materialCode === materialCode);
                    batch.set(ingredientRef, {
                        materialCode,
                        name,
                        purchaseQuantity,
                        purchaseUnit,
                        purchaseCost,
                        costPerGram: calculateCostPerGram(purchaseQuantity, purchaseUnit, purchaseCost),
                        currentStock: existingIngredient ? existingIngredient.currentStock : 0,
                        parStock: existingIngredient ? existingIngredient.parStock : 0,
                    });
                    importCount++;
                }
            }

            try {
                await batch.commit();
                showNotification(`${importCount} ingredientes importados/actualizados.`);
            } catch (error) {
                console.error("Error al importar CSV:", error);
                showNotification("Error al importar el archivo.", true);
            } finally {
                importBtn.textContent = originalBtnText;
                selectors.library.csvInput.value = '';
                selectors.library.csvStatus.textContent = '';
                validatedCsvContent = null;
            }
        }

        function handleCsvExport() {
            let csvContent = "Código,Nombre,CantidadCompra,UnidadCompra,Costo\n";
            ingredients.forEach(ing => {
                const row = [ing.materialCode, `"${ing.name}"`, ing.purchaseQuantity, ing.purchaseUnit, ing.purchaseCost].join(',');
                csvContent += row + "\r\n";
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", "ingredientes_exportados.csv");
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function renderIngredientLibrary() {
            const tableBody = selectors.library.table;
            tableBody.innerHTML = '';
            ingredients.sort((a, b) => a.name.localeCompare(b.name));
            ingredients.forEach(ing => {
                const row = tableBody.insertRow();
                const costPerUnit = ing.purchaseUnit === 'un.' ? (ing.purchaseCost / (ing.purchaseQuantity || 1)) : ing.costPerGram;
                const costText = ing.purchaseUnit === 'un.' ? `$${costPerUnit.toFixed(2)} /un.` : `$${costPerUnit.toFixed(6)} /g`;
                const purchaseInfo = `${ing.purchaseCost.toFixed(2)} / ${ing.purchaseQuantity} ${ing.purchaseUnit}`;
                row.innerHTML = `
                    <td class="table-cell text-gray-600">${ing.materialCode || 'N/A'}</td>
                    <td class="table-cell font-medium">${ing.name}</td>
                    <td class="table-cell">${purchaseInfo}</td>
                    <td class="table-cell font-semibold">${costText}</td>
                    <td class="table-cell text-right space-x-2">
                        <button data-id="${ing.id}" class="edit-ingredient-btn text-[#604029] hover:underline text-sm font-semibold">Editar</button>
                        <button data-id="${ing.id}" class="delete-ingredient-btn text-red-600 hover:underline text-sm font-semibold">Borrar</button>
                    </td>
                `;
            });
            document.querySelectorAll('.edit-ingredient-btn').forEach(btn => btn.addEventListener('click', (e) => openEditModal(e.target.dataset.id)));
            document.querySelectorAll('.delete-ingredient-btn').forEach(btn => btn.addEventListener('click', (e) => confirmDelete('ingredient', e.target.dataset.id)));
        }
        
        function openEditModal(ingredientId, isNew = false) {
            const modal = selectors.modals.editIngredient;
            if (isNew) {
                modal.form.reset();
                modal.id.value = '';
                modal.overlay.querySelector('h3').textContent = "Añadir Nuevo Ingrediente";
            } else {
                const ing = ingredients.find(i => i.id == ingredientId);
                if (!ing) return;
                modal.overlay.querySelector('h3').textContent = "Editar Ingrediente";
                modal.id.value = ing.id;
                modal.code.value = ing.materialCode;
                modal.name.value = ing.name;
                modal.quantity.value = ing.purchaseQuantity;
                modal.unit.value = ing.purchaseUnit;
                modal.cost.value = ing.purchaseCost;
            }
            modal.overlay.classList.remove('hidden');
        }

        async function handleUpdateIngredient(e) {
            e.preventDefault();
            const modal = selectors.modals.editIngredient;
            let id = modal.id.value;
            const code = parseInt(modal.code.value);
            
            if (!id) {
                await handleAddIngredient(e);
                return;
            }

            const updatedData = {
                materialCode: code,
                name: modal.name.value.trim(),
                purchaseQuantity: parseFloat(modal.quantity.value),
                purchaseUnit: modal.unit.value,
                purchaseCost: parseFloat(modal.cost.value),
            };
            updatedData.costPerGram = calculateCostPerGram(updatedData.purchaseQuantity, updatedData.purchaseUnit, updatedData.purchaseCost);
            
            try {
                await setDoc(doc(db, 'ingredients', id), updatedData, { merge: true });
                closeEditModal();
                showNotification("Ingrediente actualizado.");
            } catch (error) {
                console.error("Error al actualizar ingrediente:", error);
                showNotification("No se pudo actualizar el ingrediente.", true);
            }
        }

        // --- RECIPE LOGIC ---
        async function handleSaveRecipe() {
            const name = selectors.calculator.recipeName.value.trim();
            const yieldValue = parseFloat(selectors.calculator.recipeYield.value);
            const yieldUnit = selectors.calculator.recipeYieldUnit.value;
            const menuId = selectors.calculator.menuSelect.value;
            
            if (!name || !yieldValue || yieldValue <= 0 || !yieldUnit || currentRecipe.ingredients.length === 0) {
                showNotification("Por favor, complete nombre, rendimiento, unidad y añada ingredientes.", true);
                return;
            }
            if(currentRecipe.isFinalDish && !menuId) {
                showNotification("Por favor, asigne el plato a un menú.", true);
                return;
            }
            
            currentRecipe.name = name;
            currentRecipe.yield = yieldValue;
            currentRecipe.yieldUnit = yieldUnit;
            currentRecipe.menuId = currentRecipe.isFinalDish ? menuId : null;
            
            const recipeToSave = JSON.parse(JSON.stringify(currentRecipe));
            const recipeId = recipeToSave.id;
            delete recipeToSave.id;
             if (!recipeToSave.currentStock) recipeToSave.currentStock = 0;
            if (!recipeToSave.parStock) recipeToSave.parStock = 0;

            try {
                if (recipeId) {
                    await setDoc(doc(db, 'recipes', recipeId), recipeToSave);
                    showNotification(`Receta "${name}" actualizada!`);
                } else {
                    await addDoc(recipesCol, recipeToSave);
                    showNotification(`Receta "${name}" guardada!`);
                }
                handleClearRecipe();
            } catch (error) {
                console.error("Error al guardar:", error);
                showNotification("No se pudo guardar la receta.", true);
            }
        }
        
        function handleIngredientSearch(e) {
            const searchTerm = e.target.value.toLowerCase();
            const resultsContainer = selectors.calculator.ingredientSearchResults;

            if (!searchTerm) {
                resultsContainer.classList.add('hidden');
                return;
            }

            const filtered = combinedIngredients.filter(ing => 
                ing.name.toLowerCase().includes(searchTerm) ||
                String(ing.materialCode).startsWith(searchTerm)
            );

            resultsContainer.innerHTML = '';
            if (filtered.length > 0) {
                filtered.forEach(ing => {
                    const item = document.createElement('div');
                    item.className = 'p-3 hover:bg-[#D7A27A]/20 cursor-pointer border-b';
                    item.innerHTML = `
                        <p class="font-semibold text-[#604029]">${ing.name}</p>
                        <p class="text-sm text-gray-500">Código: ${ing.materialCode || 'N/A'}</p>
                    `;
                    item.dataset.id = ing.id;
                    item.addEventListener('click', () => selectIngredient(ing.id));
                    resultsContainer.appendChild(item);
                });
            } else {
                const noResult = document.createElement('div');
                noResult.className = 'p-2 text-gray-500';
                noResult.textContent = 'No se encontraron ingredientes';
                resultsContainer.appendChild(noResult);
            }
            
            const addNew = document.createElement('div');
            addNew.className = 'p-3 hover:bg-[#D7A27A]/20 cursor-pointer font-bold text-[#604029] border-t';
            addNew.textContent = '+ Añadir Nuevo Ingrediente...';
            addNew.addEventListener('click', () => {
                openEditModal(null, true);
                resultsContainer.classList.add('hidden');
                selectors.calculator.ingredientSearchInput.value = '';
            });
            resultsContainer.appendChild(addNew);

            resultsContainer.classList.remove('hidden');
        }

        function selectIngredient(id) {
            selectedIngredientId = id;
            const ingredient = combinedIngredients.find(ing => ing.id === id);
            if (ingredient) {
                selectors.calculator.ingredientSearchInput.value = `${ingredient.materialCode || 'N/A'} - ${ingredient.name}`;
                 const displayCost = (ingredient.purchaseUnit === 'un.') ? ingredient.costPerGram : ingredient.costPerGram;
                selectors.calculator.costPerGramPreview.textContent = `$${displayCost.toFixed(6)}`;
            }
            selectors.calculator.ingredientSearchResults.classList.add('hidden');
        }

        function handleEnterKeyAdd(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                handleAddToRecipe();
            }
        }

        function handleAddToRecipe() {
            const quantity = parseFloat(selectors.calculator.recipeQuantityInput.value);
            const unit = selectors.calculator.recipeUnitInput.value;

            if (!selectedIngredientId || !quantity || quantity <= 0) {
                showNotification("Por favor seleccione un ingrediente y una cantidad válida.", true);
                return;
            }
            
            const ingredient = combinedIngredients.find(ing => ing.id === selectedIngredientId);
            if (!ingredient) return;

             let grams = 0;
            if (ingredient.purchaseUnit === 'un.') {
                grams = quantity * (ingredient.purchaseQuantity || 1); // Special handling for 'un.' based on its own weight if available
            } else {
                grams = quantity * (CONVERSIONS[unit] || 0);
            }

            const ingredientCopy = JSON.parse(JSON.stringify(ingredient));
            const existingItem = currentRecipe.ingredients.find(item => item.id === selectedIngredientId);

            if (existingItem) {
                existingItem.grams += grams;
            } else if (ingredientCopy) {
                ingredientCopy.grams = grams;
                ingredientCopy.recipeIngredientId = Date.now();
                currentRecipe.ingredients.push(ingredientCopy);
            }
            
            renderRecipeTable();
            selectors.calculator.recipeQuantityInput.value = '';
            selectors.calculator.ingredientSearchInput.value = '';
            selectors.calculator.costPerGramPreview.textContent = '';
            selectedIngredientId = null;
            selectors.calculator.ingredientSearchInput.focus();
        }

        function renderRecipeTable() {
            const tableBody = selectors.calculator.recipeTableBody;
            tableBody.innerHTML = '';
            selectors.calculator.noIngredientsRow.style.display = currentRecipe.ingredients.length > 0 ? 'none' : 'table-row';

            currentRecipe.ingredients.forEach(item => {
                const itemCost = item.grams * item.costPerGram;
                const row = tableBody.insertRow();
                const displayCost = (item.purchaseUnit === 'un.') ? item.costPerGram : item.costPerGram;

                row.innerHTML = `
                    <td class="table-cell text-gray-600">${item.materialCode || 'N/A'}</td>
                    <td class="table-cell font-medium">${item.name}</td>
                    <td class="table-cell">
                        <input type="number" value="${item.grams.toFixed(2)}" data-id="${item.recipeIngredientId}" class="grams-input w-24 px-2 py-1 border rounded-md">
                    </td>
                    <td class="table-cell text-gray-500">g</td>
                    <td class="table-cell text-gray-600">$${displayCost.toFixed(6)}</td>
                    <td class="table-cell font-semibold">$${itemCost.toFixed(2)}</td>
                    <td class="table-cell text-right">
                        <button data-id="${item.recipeIngredientId}" class="remove-from-recipe-btn text-red-500 hover:text-red-700 font-semibold">X</button>
                    </td>
                `;
            });

            document.querySelectorAll('.grams-input').forEach(input => input.addEventListener('input', updateGrams));
            document.querySelectorAll('.remove-from-recipe-btn').forEach(btn => btn.addEventListener('click', removeFromRecipe));
            
            calculateSummary();
        }

        function updateGrams(e) {
            const id = parseInt(e.target.dataset.id);
            const newGrams = parseFloat(e.target.value) || 0;
            const item = currentRecipe.ingredients.find(item => item.recipeIngredientId === id);
            if (item) {
                item.grams = newGrams;
                const row = e.target.closest('tr');
                if(row) {
                    row.querySelector('td:nth-child(6)').textContent = `$${(newGrams * item.costPerGram).toFixed(2)}`;
                }
                calculateSummary();
            }
        }

        function removeFromRecipe(e) {
            const id = parseInt(e.target.dataset.id);
            currentRecipe.ingredients = currentRecipe.ingredients.filter(item => item.recipeIngredientId !== id);
            renderRecipeTable();
        }
        
        function handleClearRecipe() {
            currentRecipe = {
                id: null, name: '', yield: 1, yieldUnit: '', 
                isFinalDish: selectors.calculator.recipeTypeToggle.checked, ingredients: []
            };
            const calc = selectors.calculator;
            calc.recipeName.value = '';
            calc.recipeYield.value = '1';
            calc.recipeYieldUnit.value = '';
            renderRecipeTable();
        }

        // --- ALL RECIPES VIEW ---
        function renderAllRecipesView() {
            const tableBody = selectors.recipes.table;
            tableBody.innerHTML = '';

            if (savedRecipes.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="5" class="text-center py-10 text-gray-500">No hay recetas guardadas.</td></tr>`;
                return;
            }

            savedRecipes.sort((a, b) => a.name.localeCompare(b.name)).forEach(recipe => {
                const { totalCosto } = calculateRecipeMetrics(recipe);
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td class="table-cell font-medium">${recipe.name}</td>
                    <td class="table-cell">${recipe.isFinalDish ? 'Plato Final' : 'Producto Interno'}</td>
                    <td class="table-cell">$${totalCosto.toFixed(2)}</td>
                    <td class="table-cell">${recipe.yield} ${recipe.yieldUnit}</td>
                    <td class="table-cell text-right space-x-2">
                        <button data-id="${recipe.id}" class="edit-recipe-btn text-[#604029] hover:underline text-sm font-semibold">Editar</button>
                        <button data-id="${recipe.id}" class="delete-recipe-btn text-red-600 hover:underline text-sm font-semibold">Borrar</button>
                    </td>
                `;
            });
            document.querySelectorAll('.edit-recipe-btn').forEach(btn => btn.addEventListener('click', (e) => handleEditRecipe(e.target.dataset.id)));
            document.querySelectorAll('.delete-recipe-btn').forEach(btn => btn.addEventListener('click', (e) => confirmDelete('recipe', e.target.dataset.id)));
        }

        // --- FINAL DISHES VIEW ---
        function renderFinalDishes() {
            const dashboard = selectors.dishes.dashboard;
            dashboard.innerHTML = '';
            
            if (menus.length === 0) {
                dashboard.innerHTML = `<p class="text-center py-10 text-gray-500">No hay menús creados. Vaya a "Gestionar Menús" para empezar.</p>`;
                return;
            }

            menus.forEach(menu => {
                const menuDishes = savedRecipes.filter(r => r.isFinalDish && r.menuId === menu.id);
                
                const menuSection = document.createElement('div');
                menuSection.innerHTML = `
                    <div class="flex justify-between items-baseline mb-2">
                        <h3 class="text-xl font-bold text-[#604029]">${menu.name}</h3>
                        <div class="text-sm font-semibold space-x-4">
                            <span class="summary-label">Costo Sugerido: <span id="menu-suggested-cost-${menu.id}" class="summary-value">0.00</span>%</span>
                            <span class="summary-label">Costo Final: <span id="menu-final-cost-${menu.id}" class="summary-value">0.00</span>%</span>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white">
                            <thead class="bg-transparent">
                                <tr>
                                    <th class="header-cell text-left">Nombre del Plato</th>
                                    <th class="header-cell text-left">Costo p/p</th>
                                    <th class="header-cell text-left">% de Costo</th>
                                    <th class="header-cell text-left">Precio Sugerido</th>
                                    <th class="header-cell text-left">Precio Final</th>
                                    <th class="header-cell text-left">% de Costo Final</th>
                                    <th class="header-cell text-right">Acciones</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                                ${menuDishes.length === 0 ? `<tr><td colspan="7" class="text-center py-6 text-gray-500">Este menú no tiene platos.</td></tr>` : 
                                menuDishes.map(dish => {
                                    const { costoPp, costPercent, precioSugerido } = calculateRecipeMetrics(dish);
                                    const finalPrice = dish.finalPrice || '';
                                    const finalCostPercent = finalPrice ? ((costoPp / finalPrice) * 100).toFixed(2) + '%' : '';
                                    return `
                                        <tr>
                                            <td class="table-cell font-medium">${dish.name}</td>
                                            <td class="table-cell">$${costoPp.toFixed(2)}</td>
                                            <td class="table-cell">${costPercent.toFixed(2)}%</td>
                                            <td class="table-cell">$${precioSugerido.toFixed(2)}</td>
                                            <td class="table-cell">
                                                <input type="number" value="${finalPrice}" class="final-price-input w-24 p-1 border rounded-md" data-id="${dish.id}">
                                            </td>
                                            <td class="final-cost-percent-cell table-cell font-semibold">${finalCostPercent}</td>
                                            <td class="table-cell text-right space-x-2">
                                                <button data-id="${dish.id}" class="edit-recipe-btn text-[#604029] hover:underline text-sm font-semibold">Editar</button>
                                                <button data-id="${dish.id}" class="delete-recipe-btn text-red-600 hover:underline text-sm font-semibold">Borrar</button>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')
                            }
                            </tbody>
                        </table>
                    </div>
                `;
                dashboard.appendChild(menuSection);
                updateMenuCostPercentages(menu.id, menuDishes);
            });

            document.querySelectorAll('.final-price-input').forEach(input => {
                input.addEventListener('change', async (e) => {
                    const dishId = e.target.dataset.id;
                    const finalPrice = parseFloat(e.target.value) || null;
                    await setDoc(doc(db, 'recipes', dishId), { finalPrice }, { merge: true });
                });
            });
            document.querySelectorAll('.edit-recipe-btn').forEach(btn => btn.addEventListener('click', (e) => handleEditRecipe(e.target.dataset.id)));
            document.querySelectorAll('.delete-recipe-btn').forEach(btn => btn.addEventListener('click', (e) => confirmDelete('recipe', e.target.dataset.id)));
        }

        function updateMenuCostPercentages(menuId, menuDishes) {
            let totalSuggestedCostPercent = 0;
            let totalFinalCostPercent = 0;
            let finalCostCount = 0;

            menuDishes.forEach(dish => {
                const { costPercent, costoPp } = calculateRecipeMetrics(dish);
                totalSuggestedCostPercent += costPercent;
                if (dish.finalPrice) {
                    totalFinalCostPercent += (costoPp / dish.finalPrice) * 100;
                    finalCostCount++;
                }
            });

            const avgSuggested = menuDishes.length > 0 ? (totalSuggestedCostPercent / menuDishes.length).toFixed(2) : '0.00';
            const avgFinal = finalCostCount > 0 ? (totalFinalCostPercent / finalCostCount).toFixed(2) : '0.00';

            document.getElementById(`menu-suggested-cost-${menuId}`).textContent = avgSuggested;
            document.getElementById(`menu-final-cost-${menuId}`).textContent = avgFinal;
        }

        function handleEditRecipe(recipeId) {
            const recipeToEdit = savedRecipes.find(r => r.id === recipeId);
            if (!recipeToEdit) return;

            currentRecipe = JSON.parse(JSON.stringify(recipeToEdit));

            const calc = selectors.calculator;
            calc.recipeName.value = currentRecipe.name;
            calc.recipeYield.value = currentRecipe.yield;
            calc.recipeYieldUnit.value = currentRecipe.yieldUnit;
            calc.recipeTypeToggle.checked = currentRecipe.isFinalDish;
            calc.menuSelect.value = currentRecipe.menuId || '';
            
            updateUIVisibility();
            renderRecipeTable();
            switchView('calculator');
        }

        // --- INVENTORY VIEW ---
        function renderInventoryView() {
            const tableBody = selectors.inventory.tableBody;
            tableBody.innerHTML = '';
            let currentTotalValue = 0;

            combinedIngredients.sort((a,b) => a.name.localeCompare(b.name)).forEach(item => {
                const row = tableBody.insertRow();
                const stockUnit = item.isRecipe ? item.yieldUnit : item.purchaseUnit;
                
                const costPerUnit = item.isRecipe 
                    ? ((item.ingredients || []).reduce((acc, i) => acc + (i.grams * i.costPerGram), 0) / (item.yield || 1))
                    : (item.purchaseCost / (item.purchaseQuantity || 1));

                const stockValue = (item.currentStock || 0) * costPerUnit;
                if (!isNaN(stockValue)) {
                    currentTotalValue += stockValue;
                }
                
                const stockValueDisplay = isNaN(stockValue) ? '$0.00' : `$${stockValue.toFixed(2)}`;
                const costPerUnitDisplay = isNaN(costPerUnit) ? 'N/A' : `$${costPerUnit.toFixed(2)} / ${stockUnit}`;

                row.innerHTML = `
                    <td class="table-cell text-gray-600">${item.materialCode || 'N/A'}</td>
                    <td class="table-cell font-medium">${item.name}</td>
                    <td class="table-cell">
                        <input type="number" value="${item.currentStock || 0}" data-id="${item.id}" data-type="currentStock" data-is-recipe="${item.isRecipe}" class="inventory-input w-24 p-1 border rounded-md">
                    </td>
                    <td class="table-cell text-gray-600">${stockUnit}</td>
                    <td class="table-cell">
                        <input type="number" value="${item.parStock || 0}" data-id="${item.id}" data-type="parStock" data-is-recipe="${item.isRecipe}" class="inventory-input w-24 p-1 border rounded-md">
                    </td>
                    <td class="table-cell text-gray-600">${costPerUnitDisplay}</td>
                    <td class="table-cell font-semibold">${stockValueDisplay}</td>
                `;
            });
            
            totalInventoryValue = currentTotalValue;
            selectors.inventory.totalValue.textContent = `$${totalInventoryValue.toFixed(2)}`;

            document.querySelectorAll('.inventory-input').forEach(input => {
                input.addEventListener('change', handleInventoryUpdate);
            });
        }
        
        async function handleInventoryUpdate(e) {
            const { id, type, isRecipe } = e.target.dataset;
            const value = parseFloat(e.target.value) || 0;
            
            const collectionName = (isRecipe === 'true') ? 'recipes' : 'ingredients';
            const docRef = doc(db, collectionName, id);

            try {
                await updateDoc(docRef, { [type]: value });
            } catch (error) {
                console.error(`Error updating ${type} for ${id}:`, error);
                showNotification("Error al actualizar inventario.", true);
            }
        }
        
        async function handleInventorySnapshot() {
            const snapshotData = {
                createdAt: serverTimestamp(),
                totalValue: totalInventoryValue,
                items: combinedIngredients.map(item => ({
                    id: item.id,
                    name: item.name,
                    isRecipe: item.isRecipe,
                    currentStock: item.currentStock || 0,
                    stockUnit: item.isRecipe ? item.yieldUnit : item.purchaseUnit
                }))
            };
            try {
                await addDoc(snapshotsCol, snapshotData);
                showNotification("Corte de inventario guardado exitosamente.");
            } catch (error) {
                console.error("Error guardando el corte de inventario:", error);
                showNotification("No se pudo guardar el corte de inventario.", true);
            }
        }

        function renderInventoryHistoryView() {
            const list = selectors.inventoryHistory.list;
            list.innerHTML = '';
            if (inventorySnapshots.length === 0) {
                list.innerHTML = `<p class="text-center text-gray-500">No hay cortes guardados.</p>`;
                return;
            }
            inventorySnapshots.forEach(snap => {
                const date = snap.createdAt?.toDate().toLocaleString() || 'Fecha no disponible';
                const item = document.createElement('div');
                item.className = 'p-4 border rounded-lg bg-white/50';
                item.innerHTML = `
                    <div class="flex justify-between items-center">
                        <span class="font-semibold text-lg text-[#604029]">Corte de ${date}</span>
                        <span class="font-bold text-xl text-[#374151]">$${snap.totalValue.toFixed(2)}</span>
                    </div>
                `;
                list.appendChild(item);
            });
        }

        // --- VARIANCE ANALYSIS ---
        function populateVariancePeriodSelect() {
            const select = selectors.varianceAnalysis.periodSelect;
            select.innerHTML = '<option value="">Seleccione una semana...</option>';
            weeklyReports.forEach(report => {
                const option = document.createElement('option');
                option.value = report.id;
                option.textContent = `Semana del ${report.id}`;
                select.appendChild(option);
            });
        }
        
        async function calculateVariance() {
            const reportId = selectors.varianceAnalysis.periodSelect.value;
            if (!reportId) {
                showNotification("Por favor, seleccione un período de reporte.", true);
                return;
            }

            const report = weeklyReports.find(r => r.id === reportId);
            if (!report) {
                 showNotification("Reporte no encontrado.", true);
                return;
            }
            
            // 1. Calculate Theoretical Consumption
            const theoreticalConsumptionMap = new Map();
            function traceIngredients(recipe, multiplier) {
                if (!recipe || !recipe.ingredients) return;
                recipe.ingredients.forEach(ing => {
                    const foundIngredient = combinedIngredients.find(item => item.id === ing.id);
                    if (!foundIngredient) return;

                    const totalConsumedGrams = ing.grams * multiplier;

                    if (foundIngredient.isRecipe) {
                        const yieldInGrams = (foundIngredient.yield || 1) * (CONVERSIONS[foundIngredient.yieldUnit] || 1);
                        traceIngredients(foundIngredient, totalConsumedGrams / yieldInGrams);
                    } else {
                        const existing = theoreticalConsumptionMap.get(ing.id) || { name: ing.name, total: 0 };
                        theoreticalConsumptionMap.set(ing.id, { ...existing, total: existing.total + totalConsumedGrams });
                    }
                });
            }

            for (const dishId in report.sales) {
                const quantitySold = report.sales[dishId] || 0;
                if (quantitySold > 0) {
                    const dish = savedRecipes.find(r => r.id === dishId);
                    traceIngredients(dish, quantitySold);
                }
            }

            // 2. Calculate Actual Consumption
            const actualConsumptionMap = new Map();
            const startSnapshot = inventorySnapshots.find(s => s.totalValue.toFixed(2) === report.initialInventory.toFixed(2));
            const endSnapshot = inventorySnapshots.find(s => s.totalValue.toFixed(2) === report.finalInventory.toFixed(2));

            if (!startSnapshot || !endSnapshot) {
                showNotification("No se encontraron los cortes de inventario inicial o final para este reporte.", true);
                return;
            }
            
            combinedIngredients.forEach(item => {
                const startItem = startSnapshot.items.find(i => i.id === item.id);
                const endItem = endSnapshot.items.find(i => i.id === item.id);
                
                const startStockGrams = (startItem?.currentStock || 0) * (CONVERSIONS[item.stockUnit] || 1);
                const endStockGrams = (endItem?.currentStock || 0) * (CONVERSIONS[item.stockUnit] || 1);
                
                // Note: Purchases are in $, not units. This is a limitation.
                // We can only calculate variance for items where we have unit counts.
                const actualConsumptionGrams = startStockGrams - endStockGrams; // Ignoring purchases for now
                 actualConsumptionMap.set(item.id, {
                    name: item.name,
                    total: actualConsumptionGrams,
                    costPerGram: item.costPerGram || 0,
                 });
            });

            // 3. Compare and Render
            const tableBody = selectors.varianceAnalysis.resultsTable;
            tableBody.innerHTML = '';
            let totalVarianceValue = 0;
            const allItemIds = new Set([...theoreticalConsumptionMap.keys(), ...actualConsumptionMap.keys()]);


            for (const id of allItemIds) {
                const theoreticalData = theoreticalConsumptionMap.get(id) || { name: actualConsumptionMap.get(id)?.name, total: 0 };
                const actualData = actualConsumptionMap.get(id) || { name: theoreticalData.name, total: 0, costPerGram: 0 };
                const varianceGrams = actualData.total - theoreticalData.total;
                const varianceValue = varianceGrams * actualData.costPerGram;
                
                if(!isNaN(varianceValue)) {
                    totalVarianceValue += varianceValue;
                }

                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td class="table-cell font-medium">${theoreticalData.name || actualData.name}</td>
                    <td class="table-cell text-right">${theoreticalData.total.toFixed(2)}</td>
                    <td class="table-cell text-right">${actualData.total.toFixed(2)}</td>
                    <td class="table-cell text-right font-semibold ${varianceGrams < 0 ? 'text-red-600' : 'text-green-600'}">${varianceGrams.toFixed(2)}</td>
                    <td class="table-cell text-right font-bold ${varianceValue < 0 ? 'text-red-600' : 'text-green-600'}">$${varianceValue.toFixed(2)}</td>
                `;
            }

            selectors.varianceAnalysis.totalVariance.textContent = `$${totalVarianceValue.toFixed(2)}`;
            selectors.varianceAnalysis.resultsContainer.classList.remove('hidden');
        }


        // --- REPORTING LOGIC ---
        function formatDate(date) {
            return date.toISOString().split('T')[0];
        }

        function getWeekInfo(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            const monday = new Date(d.setDate(diff));
            const weekId = formatDate(monday);
            const week = Array.from({length: 7}, (_, i) => {
                const day = new Date(monday);
                day.setDate(monday.getDate() + i);
                return formatDate(day);
            });
            return { weekId, week };
        }
        
        function handleDateChange(e) {
            const newDate = new Date(e.target.value + 'T00:00:00');
            if (newDate.toDateString() !== currentReportDate.toDateString()) {
                currentReportDate = newDate;
                fetchWeeklyData(currentReportDate);
            }
        }

        function changeReportDay(offset) {
            currentReportDate.setDate(currentReportDate.getDate() + offset);
            selectors.reports.datePicker.value = formatDate(currentReportDate);
            fetchWeeklyData(currentReportDate);
        }

        async function fetchWeeklyData(date) {
            const { weekId, week } = getWeekInfo(date);
            
            const promises = week.map(dayId => getDoc(doc(dailySalesCol, dayId)));
            const daySnapshots = await Promise.all(promises);

            weeklyDataCache = {};
            daySnapshots.forEach(snap => {
                if (snap.exists()) {
                    weeklyDataCache[snap.id] = snap.data();
                }
            });
            
            renderDailyReport(date);
            calculateWeeklySummary();
        }

        function renderDailyReport(date) {
            const dateId = formatDate(date);
            selectors.reports.datePicker.value = dateId;
            const dailyData = weeklyDataCache[dateId] || { sales: {}, purchases: 0 };
            
            selectors.reports.dailyPurchaseInput.value = dailyData.purchases || '';
            
            const container = selectors.reports.salesByDishContainer;
            container.innerHTML = '';
            menus.forEach(menu => {
                const menuDishes = savedRecipes.filter(r => r.isFinalDish && r.menuId === menu.id);
                if (menuDishes.length === 0) return;

                const section = document.createElement('details');
                section.className = 'p-2 rounded-lg bg-white/30';
                section.innerHTML = `<summary class="font-semibold text-md cursor-pointer text-[#604029]">${menu.name}</summary>`;
                
                const dishList = document.createElement('div');
                dishList.className = 'mt-2 space-y-1 pl-4';
                
                menuDishes.forEach(dish => {
                    const sales = dailyData.sales?.[dish.id] || '';
                    const div = document.createElement('div');
                    div.className = 'flex items-center justify-between py-1';
                    div.innerHTML = `
                        <label class="summary-label">${dish.name}</label>
                        <input type="number" value="${sales}" class="report-sale-input w-32 p-1 border rounded-md text-right" data-dish-id="${dish.id}">
                    `;
                    dishList.appendChild(div);
                });
                section.appendChild(dishList);
                container.appendChild(section);
            });
            document.querySelectorAll('.report-sale-input').forEach(input => input.addEventListener('change', handleDailyDataUpdate));
        }

        async function handleDailyDataUpdate() {
            const dateId = formatDate(currentReportDate);
            const sales = {};
            document.querySelectorAll('.report-sale-input').forEach(input => {
                const qty = parseInt(input.value);
                if (!isNaN(qty) && qty > 0) {
                    sales[input.dataset.dishId] = qty;
                }
            });
            const purchases = parseFloat(selectors.reports.dailyPurchaseInput.value) || 0;
            
            const dailyData = { sales, purchases };
            await setDoc(doc(dailySalesCol, dateId), dailyData, { merge: true });
            
            weeklyDataCache[dateId] = dailyData;
            calculateWeeklySummary();
        }

        async function calculateWeeklySummary() {
            const { weekId, week } = getWeekInfo(currentReportDate);
            let totalSales = 0;
            let totalPurchases = 0;

            week.forEach(dayId => {
                const dayData = weeklyDataCache[dayId];
                if (dayData) {
                    totalPurchases += dayData.purchases || 0;
                    for (const dishId in dayData.sales) {
                        const qty = dayData.sales[dishId] || 0;
                        const dish = savedRecipes.find(r => r.id === dishId);
                        if (dish && dish.finalPrice) {
                            totalSales += qty * dish.finalPrice;
                        }
                    }
                }
            });

            const lastWeekId = getWeekInfo(new Date(new Date(week[0]).setDate(new Date(week[0]).getDate() - 1))).weekId;
            const lastReportSnap = await getDoc(doc(weeklyReportsCol, lastWeekId));
            const initialInv = lastReportSnap.exists() ? lastReportSnap.data().finalInventory : 0;
            const finalInv = inventorySnapshots[0]?.totalValue || 0;
            
            selectors.reports.summary.totalSales.textContent = `$${totalSales.toFixed(2)}`;
            selectors.reports.summary.purchases.textContent = `$${totalPurchases.toFixed(2)}`;
            selectors.reports.summary.initialInvInput.value = initialInv.toFixed(2);
            selectors.reports.summary.finalInvInput.value = finalInv.toFixed(2);

            const cogs = initialInv + totalPurchases - finalInv;
            const costPercent = totalSales > 0 ? (cogs / totalSales) * 100 : 0;
            
            selectors.reports.summary.cogs.textContent = `$${cogs.toFixed(2)}`;
            selectors.reports.summary.costPercent.textContent = `${costPercent.toFixed(2)}%`;
        }

        async function handleLockWeek() {
             const { weekId, week } = getWeekInfo(currentReportDate);
             const sales = {};
             let totalSales = 0;
             let totalPurchases = 0;
             
             week.forEach(dayId => {
                const dayData = weeklyDataCache[dayId];
                if (dayData) {
                    totalPurchases += dayData.purchases || 0;
                     for (const dishId in dayData.sales) {
                        const qty = dayData.sales[dishId] || 0;
                        sales[dishId] = (sales[dishId] || 0) + qty;
                        const dish = savedRecipes.find(r => r.id === dishId);
                        if (dish && dish.finalPrice) {
                            totalSales += qty * dish.finalPrice;
                        }
                    }
                }
            });

            const reportData = {
                id: weekId,
                sales,
                totalSales,
                totalPurchases,
                initialInventory: parseFloat(selectors.reports.summary.initialInvInput.value) || 0,
                finalInventory: parseFloat(selectors.reports.summary.finalInvInput.value) || 0,
            };
            
            try {
                await setDoc(doc(db, 'weeklyReports', weekId), reportData);
                showNotification("Reporte semanal guardado y cerrado.");
            } catch (error) {
                 console.error("Error guardando reporte semanal:", error);
                showNotification("No se pudo guardar el reporte.", true);
            }
        }

        function renderReportHistoryView() {
            const list = selectors.reportHistory.list;
            list.innerHTML = '';
             if (weeklyReports.length === 0) {
                list.innerHTML = `<p class="text-center text-gray-500">No hay reportes guardados.</p>`;
                return;
            }
            weeklyReports.forEach(report => {
                const item = document.createElement('div');
                item.className = 'p-4 border rounded-lg bg-white/50';
                const cogs = report.initialInventory + report.totalPurchases - report.finalInventory;
                const costPercent = report.totalSales > 0 ? (cogs / report.totalSales) * 100 : 0;
                item.innerHTML = `
                    <div class="flex justify-between items-center">
                        <span class="font-semibold text-lg text-[#604029]">Semana del ${report.id}</span>
                        <div>
                            <span class="summary-label mr-2">Costo:</span>
                            <span class="font-bold text-xl text-[#374151]">${costPercent.toFixed(2)}%</span>
                        </div>
                    </div>
                `;
                list.appendChild(item);
            });
        }


        // --- CALCULATION LOGIC ---
        function calculateSummary() {
            const { costoMp, costoPp, imprevistosValue, totalCosto, precioSugerido } = calculateRecipeMetrics(currentRecipe);
            const fv = selectors.calculator.summaryValues;
            
            fv.costoMp.textContent = `$${costoMp.toFixed(2)}`;
            fv.costoPp.textContent = `$${costoPp.toFixed(2)}`;
            fv.imprevistosValue.textContent = `$${imprevistosValue.toFixed(2)}`;
            fv.totalCosto.textContent = `$${totalCosto.toFixed(2)}`;

            if (currentRecipe.isFinalDish) {
                fv.precioSugerido.textContent = `$${precioSugerido.toFixed(2)}`;
                const tax = precioSugerido * (parseFloat(selectors.calculator.summaryInputs.taxPercent.value) / 100 || 0);
                fv.taxValue.textContent = `$${tax.toFixed(2)}`;
                fv.precioFactura.textContent = `$${(precioSugerido + tax).toFixed(2)}`;
            }
        }

        function calculateRecipeMetrics(recipeObject) {
            const calc = selectors.calculator;
            const yieldVal = recipeObject.yield || 1;
            const costoMp = (recipeObject.ingredients || []).reduce((acc, item) => acc + (item.grams * item.costPerGram), 0);
            const costoPp = yieldVal > 0 ? costoMp / yieldVal : 0;
            const imprevistosPercent = parseFloat(calc.summaryInputs.imprevistosPercent.value) || 0;
            const imprevistosValue = costoMp * (imprevistosPercent / 100);
            const totalCosto = costoMp + imprevistosValue;
            
            const costPercentVal = parseFloat(calc.summaryInputs.costPercent.value) || 100;
            const precioSugerido = costPercentVal > 0 ? (totalCosto / (costPercentVal / 100)) : 0;
            
            return { costoMp, costoPp, imprevistosValue, totalCosto, costPercent: costPercentVal, precioSugerido };
        }
        

        // --- MODAL & DELETE LOGIC ---
        function closeEditModal() {
            selectors.modals.editIngredient.overlay.classList.add('hidden');
        }

        function confirmDelete(type, id) {
            const modal = selectors.modals.confirmDelete;
            let item;
            if (type === 'ingredient') item = ingredients.find(i => i.id === id);
            else if (type === 'recipe') item = savedRecipes.find(r => r.id === id);
            else item = menus.find(m => m.id === id);

            if (!item) return;

            modal.message.textContent = `¿Está seguro de que desea eliminar "${item.name}"? Esta acción no se puede deshacer.`;
            modal.overlay.classList.remove('hidden');

            const confirmAction = async () => {
                try {
                    if (type === 'ingredient') await deleteDoc(doc(db, 'ingredients', id));
                    else if (type === 'recipe') await deleteDoc(doc(db, 'recipes', id));
                    else if (type === 'menu') await deleteDoc(doc(db, 'menus', id));
                    showNotification("Item eliminado.");
                } catch (error) {
                    console.error("Error al eliminar:", error);
                    showNotification("No se pudo eliminar el item.", true);
                } finally {
                    closeConfirmModal();
                }
            };
            
            modal.cancelBtn.onclick = closeConfirmModal;
            modal.confirmBtn.onclick = confirmAction;
            modal.overlay.onclick = (e) => { if(e.target === e.currentTarget) closeConfirmModal() };
        }

        function closeConfirmModal() {
            const modal = selectors.modals.confirmDelete;
            modal.overlay.classList.add('hidden');
            modal.confirmBtn.onclick = null;
            modal.cancelBtn.onclick = null;
            modal.overlay.onclick = null;
        }

        // --- MENU MANAGEMENT ---
        async function handleAddMenu(e) {
            e.preventDefault();
            const input = selectors.modals.manageMenus.input;
            const name = input.value.trim();
            if (name) {
                try {
                    await addDoc(menusCol, { name });
                    input.value = '';
                    showNotification(`Menú "${name}" creado.`);
                } catch (error) {
                    console.error("Error al crear menú:", error);
                    showNotification("No se pudo crear el menú.", true);
                }
            }
        }
        
        function renderMenuList() {
            const list = selectors.modals.manageMenus.list;
            list.innerHTML = '';
            menus.forEach(menu => {
                const item = document.createElement('div');
                item.className = 'flex justify-between items-center p-2 border rounded';
                item.innerHTML = `<span>${menu.name}</span> <button data-id="${menu.id}" class="delete-menu-btn text-red-500 font-bold">X</button>`;
                list.appendChild(item);
            });
            document.querySelectorAll('.delete-menu-btn').forEach(btn => btn.addEventListener('click', (e) => confirmDelete('menu', e.target.dataset.id)));
        }
        
        function populateMenuDropdowns() {
            const selects = [selectors.calculator.menuSelect];
            selects.forEach(select => {
                if (!select) return;
                select.innerHTML = '<option value="">Seleccione un Menú...</option>';
                menus.forEach(menu => {
                    const option = document.createElement('option');
                    option.value = menu.id;
                    option.textContent = menu.name;
                    select.appendChild(option);
                });
            });
        }


        // --- INITIALIZATION ---
        function renderAllDynamicViews() {
            renderIngredientLibrary();
            renderAllRecipesView();
            renderFinalDishes();
            renderMenuList();
            populateMenuDropdowns();
            renderInventoryView();
        }

        window.onload = () => {
            setupEventListeners();
            handleClearRecipe();
            switchView('calculator');
        };
    </script>
</body>
</html>

